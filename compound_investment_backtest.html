<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>复利定投回测计算器</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 720px;
      margin: 20px auto;
      padding: 0 15px 60px;
      background: #f9f9f9;
      color: #333;
      word-break: break-word;
      line-height: 1.6;
    }
    h1 {
      text-align: center;
      margin-bottom: 1em;
    }
    form {
      background: #fff;
      padding: 20px 25px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      margin-bottom: 2em;
      font-size: 1rem;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      color: #555;
    }
    select, input[type="number"] {
      width: 100%;
      padding: 8px 12px;
      font-size: 1rem;
      margin-top: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    select:focus, input[type="number"]:focus {
      border-color: #409eff;
      outline: none;
      box-shadow: 0 0 5px #a6c8ff;
    }
    button {
      margin-top: 20px;
      padding: 10px 24px;
      background: #409eff;
      border: none;
      color: #fff;
      font-weight: 600;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
      font-size: 1.1rem;
    }
    button:hover {
      background: #66b1ff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      border-radius: 6px;
      overflow: hidden;
      font-size: 0.95rem;
      margin-top: 10px;
    }
    thead {
      background: #409eff;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      text-align: center;
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      word-break: break-word;
      vertical-align: middle;
    }
    tbody tr.year-color-0 {
      background-color: #fff;
    }
    tbody tr.year-color-1 {
      background-color: #f0f7ff;
    }
    tbody tr.highlight-row {
      background-color: #ffeaa7 !important;
      transition: background-color 0.3s;
    }
    /* 响应式 */
    @media (max-width: 480px) {
      body {
        padding: 15px 12px 50px;
      }
      form {
        padding: 15px 18px;
      }
      label {
        margin-top: 12px;
        font-size: 0.95rem;
      }
      select, input[type="number"] {
        font-size: 0.9rem;
        padding: 7px 10px;
      }
      button {
        width: 100%;
        margin-top: 15px;
        font-size: 1rem;
        padding: 10px 0;
      }
      table {
        font-size: 0.85rem;
      }
      th, td {
        padding: 8px 6px;
      }
    }
    #chart {
      width: 100%;
      height: 320px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      margin-bottom: 2em;
    }
  </style>
</head>
<body>
  <div id="app" role="main" aria-label="复利定投回测功能">
    <h1>复利定投回测计算器</h1>
    <form @submit.prevent="runBacktest" aria-label="回测参数表单">
      <label for="selectData">选择回测数据:</label>
      <select id="selectData" v-model="selectedDataName" required @change="onDataChange">
        <option disabled value="">请选择数据</option>
        <option v-for="item in select" :key="item.name" :value="item.name">{{ item.name }}</option>
      </select>

      <label for="startDate">开始日期:</label>
      <select id="startDate" v-model="selectedStartDate" required>
        <option disabled value="">请选择开始月份</option>
        <option v-for="item in monthlyData" :key="item.date" :value="item.date">{{ item.date }}</option>
      </select>

      <label for="endDate">结束日期:</label>
      <select id="endDate" v-model="selectedEndDate" required>
        <option disabled value="">请选择结束月份</option>
        <option 
          v-for="item in monthlyData.slice().reverse()" 
          :key="'end-' + item.date" 
          :value="item.date" 
          :disabled="isEndDateDisabled(item.date)">
          {{ item.date }}
        </option>
      </select>

      <label for="initialInvestment">初始投入资金（元）:</label>
      <input id="initialInvestment" type="number" v-model.number="initialInvestment" min="0" step="0.01" required />

      <label for="monthlyInvestment">每月定投金额（元）:</label>
      <input id="monthlyInvestment" type="number" v-model.number="monthlyInvestment" min="0" step="0.01" required />

      <label for="beta">收益调整系数 β（beta）:</label>
      <input id="beta" type="number" v-model.number="beta" min="0" step="0.01" required />

      <button type="submit">开始回测</button>
      <button type="button" v-if="results.length" @click="exportCSV">导出CSV</button>
    </form>

    <section v-if="results.length" aria-live="polite" aria-atomic="true" style="margin-bottom: 1.5em;">
      <h3 style="margin-top:0; margin-bottom: 10px; color: #409eff;">回测结果：</h3>
      <table aria-label="回测结果表">
        <thead style="position: sticky;top: 0;z-index: 1;">
          <tr>
            <th>日期</th>
            <th>收盘价</th>
            <th>累计本金（元）</th>
            <th>未来价值（元）</th>
            <th>收益（元）</th>
            <th>收益倍数</th>
            <th>年化收益率（%）</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(item, idx) in results" :key="idx" :class="idx % 2 === 0 ? 'year-color-0' : 'year-color-1'">
            <td>{{ item.date }}</td>
            <td>{{ item.close.toFixed(2) }}</td>
            <td>{{ formatCurrency(item.principal) }}</td>
            <td>{{ formatCurrency(item.futureValue) }}</td>
            <td>{{ formatCurrency(item.profit) }}</td>
            <td>{{ item.returnRatio.toFixed(2) }}倍</td>
            <td>{{ (item.cagr * 100).toFixed(2) }}</td>
          </tr>
        </tbody>
      </table>
      <p style="margin-top: 1em; font-weight: 600;">最终年化收益率：{{ (finalCAGR * 100).toFixed(2) }}%</p>
    </section>

    <div id="chart" role="img" aria-label="回测收益走势图"></div>
  </div>

  <script src="https://summerson-kiritani.github.io/calculate_etf_investment/qqq_data.js"></script>
  <script src="https://summerson-kiritani.github.io/calculate_etf_investment/qld_data.js"></script>
  <script src="https://summerson-kiritani.github.io/calculate_etf_investment/tqqq_data.js"></script>
  <script src="https://summerson-kiritani.github.io/calculate_etf_investment/xauusd_data.js"></script>
  <script src="https://summerson-kiritani.github.io/calculate_etf_investment/spy_data.js"></script>
  <script src="https://summerson-kiritani.github.io/calculate_etf_investment/btcusd_data.js"></script>
  <script src="https://summerson-kiritani.github.io/calculate_etf_investment/hs_data.js"></script>
  <script src="https://summerson-kiritani.github.io/calculate_etf_investment/zh500_data.js"></script>
  <script src="https://summerson-kiritani.github.io/calculate_etf_investment/zh1000_data.js"></script>

  <script>
    let select = [
      {
        name: 'QQQ',
        data: qqqData,
      },
      {
        name: 'QLD',
        data: qldData,
      },
      {
        name: 'TQQQ',
        data: tqqqData,
      },
      {
        name: 'SPY',
        data: spyData,
      },
      {
        name: 'XAU/USD(黄金)',
        data: xauusdData,
      },
      {
        name: 'BTC/USD(比特币)',
        data: btcusdData,
      },
      {
        name: '沪深300ETF',
        data: hsData,
      },
      {
        name: '中证500ETF',
        data: zh500Data,
      },
      {
        name: '中证1000ETF',
        data: zh1000Data,
      },
    ];

    new Vue({
      el: '#app',
      data() {
        return {
          select: select,
          selectedDataName: '',
          monthlyData: [],
          selectedStartDate: '',
          selectedEndDate: '',
          initialInvestment: 10000,
          monthlyInvestment: 1000,
          beta: 1,
          results: [],
          finalCAGR: 0,
          chart: null
        }
      },
      watch: {
        selectedDataName(val) {
          this.updateMonthlyData();
        },
        monthlyData() {
          // 重置日期选择
          this.selectedStartDate = '';
          this.selectedEndDate = '';
          this.results = [];
          this.finalCAGR = 0;
          this.clearChart();
        },
      },
      methods: {
        formatCurrency(num) {
          return num.toLocaleString('zh-CN', {minimumFractionDigits:2, maximumFractionDigits:2});
        },
        updateMonthlyData() {
          const selected = this.select.find(item => item.name === this.selectedDataName);
          if (selected && selected.data && selected.data.length) {
            // 保证数据按日期升序
            this.monthlyData = selected.data.slice().sort((a,b) => new Date(a.date) - new Date(b.date));
          } else {
            this.monthlyData = [];
          }
        },
        isEndDateDisabled(date) {
          if (!this.selectedStartDate) return false;
          // 结束日期必须大于等于开始日期
          return new Date(date) < new Date(this.selectedStartDate);
        },
        runBacktest() {
          if (!this.selectedStartDate) {
            alert('请选择开始日期');
            return;
          }
          if (!this.selectedEndDate) {
            alert('请选择结束日期');
            return;
          }
          if (new Date(this.selectedEndDate) < new Date(this.selectedStartDate)) {
            alert('结束日期不能早于开始日期');
            return;
          }
          if (this.initialInvestment < 0 || this.monthlyInvestment < 0 || this.beta < 0) {
            alert('请输入合理的参数');
            return;
          }

          this.results = [];
          this.finalCAGR = 0;

          const startIdx = this.monthlyData.findIndex(d => d.date === this.selectedStartDate);
          const endIdx = this.monthlyData.findIndex(d => d.date === this.selectedEndDate);
          if (startIdx === -1 || endIdx === -1) {
            alert('开始或结束日期数据未找到');
            return;
          }
          if (endIdx < startIdx) {
            alert('结束日期不能早于开始日期');
            return;
          }

          const startPrice = this.monthlyData[startIdx].close;
          let totalShares = this.initialInvestment / startPrice;
          let totalPrincipal = this.initialInvestment;
          const monthlyInvestment = this.monthlyInvestment;

          for (let i = startIdx; i <= endIdx; i++) {
            const date = this.monthlyData[i].date;
            const price = this.monthlyData[i].close;

            if (i > startIdx) {
              const sharesBought = monthlyInvestment / price;
              totalShares += sharesBought;
              totalPrincipal += monthlyInvestment;
            }

            const futureValue = totalShares * price * this.beta;
            const profit = futureValue - totalPrincipal;
            const returnRatio = totalPrincipal > 0 ? futureValue / totalPrincipal : 0;

            const monthsElapsed = i - startIdx + 1;
            const yearsElapsed = monthsElapsed / 12;
            let cagr = 0;
            if (returnRatio > 0 && yearsElapsed > 0) {
              cagr = Math.pow(returnRatio, 1 / yearsElapsed) - 1;
            }

            this.results.push({
              date,
              close: price,
              principal: totalPrincipal,
              futureValue,
              profit,
              returnRatio,
              cagr
            });
          }

          if (this.results.length > 0) {
            this.finalCAGR = this.results[this.results.length - 1].cagr;
          }

          this.renderChart();
        },
        exportCSV() {
          if (!this.results.length) {
            alert('没有数据可导出！');
            return;
          }
          const headers = [
            '日期',
            '收盘价',
            '累计本金（元）',
            '未来价值（元）',
            '收益（元）',
            '收益倍数',
            '年化收益率（%）'
          ];

          const rows = this.results.map(item => [
            item.date,
            item.close.toFixed(2),
            item.principal.toFixed(2),
            item.futureValue.toFixed(2),
            item.profit.toFixed(2),
            item.returnRatio.toFixed(2),
            (item.cagr * 100).toFixed(2)
          ]);

          function safeCSVField(field) {
            const fieldStr = String(field);
            if (fieldStr.includes(',') || fieldStr.includes('\n') || fieldStr.includes('"')) {
              return `"${fieldStr.replace(/"/g, '""')}"`;
            }
            return fieldStr;
          }

          let csvContent = headers.map(safeCSVField).join(',') + '\r\n';
          rows.forEach(row => {
            csvContent += row.map(safeCSVField).join(',') + '\r\n';
          });

          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);

          const link = document.createElement('a');
          link.href = url;
          const fileName = `复利定投回测结果_${this.selectedDataName}_${this.selectedStartDate}_${this.selectedEndDate}.csv`;
          link.setAttribute('download', fileName);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        },
        renderChart() {
          if (!this.chart) {
            this.chart = echarts.init(document.getElementById('chart'));
          }
          const dates = this.results.map(item => item.date);
          const futureValues = this.results.map(item => Number(item.futureValue.toFixed(2)));
          const principals = this.results.map(item => Number(item.principal.toFixed(2)));
          const profits = this.results.map(item => Number(item.profit.toFixed(2)));

          const option = {
            title: {
              text: `回测收益走势图 - ${this.selectedDataName}`,
              left: 'center',
              textStyle: {
                fontSize: 16,
                fontWeight: 'bold',
                color: '#333'
              }
            },
            tooltip: {
              trigger: 'axis',
              formatter: function(params) {
                let res = params[0].axisValue + '<br/>';
                params.forEach(item => {
                  res += item.marker + item.seriesName + ': ' + item.data.toLocaleString() + '<br/>';
                });
                return res;
              },
              axisPointer: {
                type: 'cross',
                crossStyle: {
                  color: '#999'
                }
              }
            },
            legend: {
              data: ['未来价值','累计本金','收益'],
              top: 30
            },
            grid: {
              left: '3%',
              right: '4%',
              bottom: '10%',
              containLabel: true
            },
            xAxis: {
              type: 'category',
              boundaryGap: false,
              data: dates,
              axisLabel: {
                rotate: 45,
                formatter: function(value) {
                  return value.replace(/\//g, '-');
                }
              }
            },
            yAxis: {
              type: 'value',
              name: '金额（元）',
              axisLabel: {
                formatter: function(value) {
                  if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
                  if (value >= 1e3) return (value / 1e3).toFixed(0) + 'k';
                  return value;
                }
              }
            },
            series: [
              {
                name: '未来价值',
                type: 'line',
                smooth: true,
                data: futureValues,
                itemStyle: {
                  color: '#409eff'
                }
              },
              {
                name: '累计本金',
                type: 'line',
                smooth: true,
                data: principals,
                itemStyle: {
                  color: '#67c23a'
                }
              },
              {
                name: '收益',
                type: 'line',
                smooth: true,
                data: profits,
                itemStyle: {
                  color: '#e6a23c'
                }
              }
            ]
          };
          this.chart.setOption(option);
          window.addEventListener('resize', () => {
            if (this.chart) this.chart.resize();
          });
        },
        clearChart() {
          if (this.chart) {
            this.chart.clear();
          }
        },
        onDataChange() {
          this.updateMonthlyData();
        }
      }
    });
  </script>
</body>
</html>

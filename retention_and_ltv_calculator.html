<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>净孖展比率计算器（基于模拟下跌资产重新计算抵押品价值）</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 0 15px;
      background: #f7fafc;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
      color: #0b3d91;
      font-weight: 700;
    }
    form {
      background: #fff;
      padding: 20px 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      color: #1e293b;
    }
    input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      margin-top: 6px;
      font-size: 1rem;
      border: 1px solid #cbd5e1;
      border-radius: 5px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input[type="number"]:focus {
      border-color: #2563eb;
      outline: none;
    }
    button {
      margin-top: 20px;
      width: 100%;
      padding: 12px 0;
      background-color: #0b3d91;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0a357c;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
      font-size: 1rem;
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #e2e8f0;
      text-align: center;
      color: #334155;
    }
    th {
      background: #0b3d91;
      color: white;
      font-weight: 700;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .text-green {
      color: #15803d;
      font-weight: 700;
    }
    .text-orange {
      color: #b45309;
      font-weight: 700;
    }
    .text-red {
      color: #b91c1c;
      font-weight: 700;
    }
    .font-weight-bold {
      font-weight: 900 !important;
    }
    .note {
      background: #e0f2fe;
      border-left: 4px solid #0b3d91;
      padding: 15px 20px;
      margin-top: 20px;
      border-radius: 6px;
      font-size: 0.95rem;
      color: #1e40af;
      line-height: 1.5;
      white-space: pre-wrap;
      font-family: "Courier New", Courier, monospace;
    }
  </style>
</head>
<body>
  <div id="app" role="main">
    <h1>净孖展比率计算器（基于模拟下跌资产重新计算抵押品价值）</h1>
    <form @submit.prevent="calculateNMR" aria-label="净孖展比率计算表单">
      <label for="totalAsset">抵押资产市值总额（港币万元）</label>
      <input
        id="totalAsset"
        type="number"
        v-model.number="totalAsset"
        min="1"
        step="0.01"
        required
        aria-describedby="totalAssetHelp"
      />
      <small id="totalAssetHelp">您所有认可抵押资产的当前市场价值总和</small>

      <label for="mixedLTV">混合信贷率（最高贷款比例，%）</label>
      <input
        id="mixedLTV"
        type="number"
        v-model.number="mixedLTV"
        min="1"
        max="100"
        step="0.1"
        required
        aria-describedby="mixedLTVHelp"
      />
      <small id="mixedLTVHelp">根据信贷评估，最高可借款额度占资产市值的百分比</small>

      <label for="loanAmount">未偿还贷款金额（港币万元）</label>
      <input
        id="loanAmount"
        type="number"
        v-model.number="loanAmount"
        :max="totalAsset"
        min="0"
        step="0.01"
        required
        aria-describedby="loanAmountHelp"
      />
      <small id="loanAmountHelp">当前您已借出的贷款金额</small>

      <label for="dropPercent">模拟资产下跌百分比（%）</label>
      <input
        id="dropPercent"
        type="number"
        v-model.number="dropPercent"
        min="0"
        max="100"
        step="0.1"
        required
        aria-describedby="dropPercentHelp"
      />
      <small id="dropPercentHelp">请输入您想模拟的资产市值下跌百分比</small>

      <button type="submit">计算净孖展比率</button>
    </form>

    <table v-if="calculated" aria-live="polite" aria-label="计算结果">
      <thead>
        <tr>
          <th>项目</th>
          <th>数值</th>
          <th>说明</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>原始抵押资产市值总额</td>
          <td>{{ formatNumber(totalAsset) }} 万港币</td>
          <td>输入的当前资产市值</td>
        </tr>
        <tr>
          <td>模拟下跌后抵押资产市值</td>
          <td>{{ formatNumber(droppedAsset) }} 万港币</td>
          <td>资产市值按下跌百分比调整后的值</td>
        </tr>
        <tr>
          <td>混合信贷率</td>
          <td>{{ mixedLTV.toFixed(2) }} %</td>
          <td>最高贷款比例</td>
        </tr>
        <tr>
          <td>抵押品价值总额（基于原始资产）</td>
          <td>{{ formatNumber(originalCollateralValue) }} 万港币</td>
          <td>原始资产市值 × 混合信贷率</td>
        </tr>
        <tr>
          <td>抵押品价值总额（基于模拟下跌资产）</td>
          <td>{{ formatNumber(droppedCollateralValue) }} 万港币</td>
          <td>模拟下跌资产市值 × 混合信贷率</td>
        </tr>
        <tr>
          <td>未偿还贷款金额</td>
          <td>{{ formatNumber(loanAmount) }} 万港币</td>
          <td>当前贷款余额</td>
        </tr>
        <tr>
          <td>净孖展比率 (NMR) - 原始资产</td>
          <td :class="nmrClass">{{ nmrPercentageDisplay }}</td>
          <td>
            (资产市值 - 贷款余额) ÷ (资产市值 - 抵押品价值总额)
          </td>
        </tr>
        <tr>
          <td>净孖展比率 (NMR) - 模拟下跌后资产</td>
          <td :class="droppedNmrClass">{{ droppedNmrPercentageDisplay }}</td>
          <td>
            (模拟下跌资产市值 - 贷款余额) ÷ (模拟下跌资产市值 - 模拟下跌后的抵押品价值总额)
          </td>
        </tr>
        <tr>
          <td>风险状态（模拟下跌后）</td>
          <td :class="droppedRiskClass" colspan="2">{{ droppedRiskMessage }}</td>
        </tr>
      </tbody>
    </table>

    <div class="note" v-if="calculated" aria-label="计算说明">
      计算说明：

      抵押品价值总额 = 资产市值 × 混合信贷率 (%)

      净孖展比率 (NMR) = (资产市值 - 未偿还贷款) ÷ (资产市值 - 抵押品价值总额)

      模拟下跌后资产市值 = 原始资产市值 × (1 - 下跌百分比 / 100)

      补仓及清盘标准：
      - NMR >= 100%：安全状态
      - 80% <= NMR < 100%：差额通知，建议补仓
      - 60% <= NMR < 80%：补仓通知，需尽快补仓
      - NMR < 60%：强制清盘风险，银行有权强制售出资产

      说明：
      这里抵押品价值总额会随资产市值变化而调整，更符合实际业务逻辑。
    </div>
  </div>

  <script>
    new Vue({
      el: "#app",
      data() {
        return {
          totalAsset: 1500, // 万港币
          mixedLTV: 60,     // 百分比%
          loanAmount: 839.44,  // 万港币
          dropPercent: 0,   // 资产模拟下跌百分比
          calculated: false,
        };
      },
      computed: {
        originalCollateralValue() {
          return this.totalAsset * (this.mixedLTV / 100);
        },
        droppedAsset() {
          return this.totalAsset * (1 - this.dropPercent / 100);
        },
        droppedCollateralValue() {
          return this.droppedAsset * (this.mixedLTV / 100);
        },
        nmr() {
          const denominator = this.totalAsset - this.originalCollateralValue;
          if (denominator <= 0) return null;
          return (this.totalAsset - this.loanAmount) / denominator;
        },
        nmrPercentage() {
          return this.nmr !== null ? this.nmr * 100 : null;
        },
        droppedNmr() {
          const denominator = this.droppedAsset - this.droppedCollateralValue;
          if (denominator <= 0) return -1;  // 极高风险，可能强制清盘
          return (this.droppedAsset - this.loanAmount) / denominator;
        },
        droppedNmrPercentage() {
          return this.droppedNmr !== null && this.droppedNmr !== -1 ? this.droppedNmr * 100 : null;
        },
        nmrClass() {
          if (this.nmrPercentage === null) return "text-red";
          if (this.nmrPercentage >= 100) return "text-green";
          if (this.nmrPercentage >= 80) return "text-orange";
          return "text-red";
        },
        droppedNmrClass() {
          if (this.droppedNmr === -1) return "text-red font-weight-bold";
          if (this.droppedNmrPercentage === null) return "text-red";
          if (this.droppedNmrPercentage >= 100) return "text-green";
          if (this.droppedNmrPercentage >= 80) return "text-orange";
          return "text-red";
        },
        droppedRiskMessage() {
          if (this.droppedNmr === null) return "计算异常，请检查输入。";
          if (this.droppedNmr === -1) return "资产价值严重下跌，贷款风险极高，可能已触发强制清盘。";
          if (this.droppedNmrPercentage >= 100) {
            return "安全：模拟下跌后净孖展比率符合要求，无需补仓。";
          } else if (this.droppedNmrPercentage >= 80) {
            return "差额通知：模拟下跌后风险增加，请考虑补仓。";
          } else if (this.droppedNmrPercentage >= 60) {
            return "补仓通知：模拟下跌后风险较高，请尽快补仓或减少贷款。";
          } else {
            return "强制清盘风险：模拟下跌后净孖展比率过低，可能被强制清盘。";
          }
        },
        nmrPercentageDisplay() {
          if (this.nmrPercentage === null) return "计算异常";
          return this.nmrPercentage.toFixed(2) + " %";
        },
        droppedNmrPercentageDisplay() {
          if (this.droppedNmr === -1) return "极高风险（可能强制清盘）";
          if (this.droppedNmrPercentage === null) return "计算异常";
          return this.droppedNmrPercentage.toFixed(2) + " %";
        }
      },
      methods: {
        calculateNMR() {
          if (this.totalAsset <= 0) {
            alert("请填写有效的抵押资产市值。");
            return;
          }
          if (this.mixedLTV <= 0 || this.mixedLTV > 100) {
            alert("混合信贷率应在1至100之间。");
            return;
          }
          if (this.loanAmount < 0) {
            alert("贷款金额不能为负数。");
            return;
          }
          if (this.loanAmount > this.totalAsset) {
            alert("贷款金额不能超过抵押资产市值。");
            return;
          }
          if (this.dropPercent < 0 || this.dropPercent > 100) {
            alert("模拟资产下跌百分比应在0至100之间。");
            return;
          }
          this.calculated = true;
        },
        formatNumber(num) {
          if (num === null) return "计算异常";
          return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
      },
      mounted() {
        this.calculateNMR();
      }
    });
  </script>
</body>
</html>
